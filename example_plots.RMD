---
title: "Urban Institute R Theme Example Plots"
author: "Aaron Williams"
date: "February 13, 2017"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: TRUE 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)

library(tidyverse)
library(datasets)

options(scipen = 999)
```

## Bar Plots

### One Color

```{r barplots}
source("urban_ggplot_theme_new_formatting.R")
ggplot(data = mtcars, mapping = aes(factor(cyl))) + 
  geom_bar() + 
  ylim(c(0, 50)) +
  labs(title = "Gg",
       subtitle = "Gg",
       caption = "Urban Institute")

source("urban_theme.R")
ggplot(data = mtcars, mapping = aes(factor(cyl))) +
  geom_bar() + 
  labs(title = "Gg",
       subtitle = "Gg",
       caption = "Urban Institute") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 20))
```


### Three Colors 
``` {r barplot with 3 colors}
#3 colors
ggplot(data = mtcars, mapping = aes(x = factor(cyl), fill = factor(cyl))) +
  geom_bar() +
  labs(title = "Gg",
       subtitle = "Gg",
       caption = "Urban Institute") +
  scale_y_continuous(expand = c(0, 0))
```

### Stacked Bar Plot
```{r stacked bar plot}
#5 colors (stacked)
ggplot(data = diamonds, mapping = aes(clarity, fill = cut)) + 
  geom_bar() +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 15000)) +
  xlab("Clarity") +
  ylab("Count") +
  labs(
    title = "Diamond Clarity",
    subtitle = "Something Informative About Diamonds",
    caption = "The Source of Diamond Data")
```

### Five Colors (Dodged)
```{r dodged bar plot}
#5 colors (dodged)
ggplot(data = diamonds, mapping = aes(clarity, fill = cut)) + 
  geom_bar(position = "dodge") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 6000)) +
  xlab("Clarity") +
  ylab("Count") +
  labs(
    title = "Diamond Clarity",
    subtitle = "Something Informative About Diamonds",
    caption = "The Source of Diamond Data")

```

## Scatter Plots
```{r one-color scatter plot}
# 1 Color
ggplot(data = diamonds, mapping = aes(x = carat, y = price)) + 
  geom_point() + 
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Title")
```

### High-Density Scatterplot with Transparency
```{r alpha scatter plot}
ggplot(data = diamonds, mapping = aes(x = carat, y = price)) + 
  geom_point(alpha = 0.1) + 
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Title",
       subtitle = "alpha = 0.1 adds transparency to overlapping points")
```

### Hex Scatterplot
``` {r scatter plot hex}
ggplot(data = diamonds, mapping = aes(x = carat, y = price)) + 
  geom_hex() + 
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Title",
       subtitle = "geom_hex adds clarity to overlapping points") +
  theme(legend.position = "right",
        legend.direction = "vertical")

#3 colors
ggplot(data = mtcars, mapping = aes(x = wt, y = mpg)) + 
  geom_point(aes(colour = factor(cyl))) + 
  labs(title = "Title")

#9 colors
dsamp <- diamonds[sample(nrow(diamonds), 1000), ]
ggplot(data = dsamp, mapping = aes(x = carat, y = price, color = clarity)) +
  geom_point(size = 3) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 20000)) +
  labs(title = "Title") +
  xlab("Carat") +
  ylab("Price (USD)")
```

## Line Charts
```{r line charts}
#3 colors
library(tidyverse)
mtcars %>% 
  select(mpg, disp, hp, wt) %>%
  gather(-mpg, key = variable, value = value) %>%
  ggplot(mapping = aes(mpg, value, color = variable)) +
  geom_line(size = 1) +
  labs(title = "Title") 

##Facet Grid
ggplot(mtcars, aes(mpg, wt)) +
  geom_point() + 
  ggtitle("Title") +
  facet_grid(vs ~ am, margins = TRUE)


```

## Binning

### Histogram

```{r histogram}

##Histogram
ggplot(data = diamonds, mapping = aes(x = depth)) + 
  geom_histogram(bins = 100) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Title")

diamonds %>%
  filter(cut == "Fair" | cut == "Premium") %>%
  ggplot(mapping = aes(x = depth, fill = cut)) + 
  geom_histogram(bins = 100) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Title")
```

### Frequency Polygon
```{r frequency polygon}

population %>%
  filter(year == 2013 & population < 3000000) %>%
  ggplot(mapping = aes(x = population)) + 
  geom_freqpoly() +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Title")

diamonds %>%
  filter(cut == "Ideal" | cut == "Premium") %>%
  ggplot(aes(x = price, color = cut)) +
  geom_freqpoly(size = 1)
```





### Box Plot
```{r box plot}
ggplot(InsectSprays, aes(x = spray, y = count)) +
  geom_boxplot() +
  scale_y_continuous(expand = c(0, 0))
```

### Violin Plot
```{r violin plot}
ggplot(InsectSprays, aes(x = spray, y = count, fill = spray)) +
  geom_violin() +
    scale_y_continuous(expand = c(0, 0))
```

## Area Plot

### Stacked Area
```{r area plot stack}

txhousing %>%
  filter(city == "Austin" | city == "Houston"| city == "Dallas"| city == "San Antonio" | city == "Fort Worth") %>%
  group_by(city, year) %>%
  summarize(sales = sum(sales)) %>%
  ggplot(aes(x = year, y = sales, fill = city)) +
    geom_area(position = "stack")
```

### Filled Area
```{r area plot fill}
txhousing %>%
  filter(city == "Austin" | city == "Houston"| city == "Dallas"| city == "San Antonio" | city == "Fort Worth") %>%
  group_by(city, year) %>%
  summarize(listings = sum(listings)) %>%
  mutate(listings = ifelse(is.na(listings), lag(listings), listings)) %>%
  ggplot(aes(x = year, y = listings, fill = city)) +
    geom_area(position = "fill")

```


## Waffle Chart / Square Pie Chart

The waffle package {[CRAN](https://cran.r-project.org/web/packages/waffle/waffle.pdf) and [Github](https://github.com/hrbrmstr/waffle)} makes creating square pie charts easy. It can also be combined with [glpyhs](http://fontawesome.io/) for more elegant shapes than squares. This example uses data pulled from [A Vision for an Equitable DC](http://www.urban.org/features/vision-equitable-dc).

```{r waffle}
library(waffle)
parts <- c(80, 30, 20, 10)
waffle(parts, rows = 8)

parts <- c(`Un-breached\nUS Population` = (318 - 11 - 79), `Premera` = 11, `Anthem` = 79)
waffle(parts, rows = 8, size = 1, colors = c("#969696", "#1879bf", "#009bda"), legend_pos = "bottom") +
  labs(title = "Boom")

white <- c(`With Degree` = 169300, `Without Degree` = 800)
black <- c(`With Degree` = 174900, `Without Degree` = 34700)
hispanic <- c(`With Degree` = 27700, `Without Degree` = 12400)

iron(
  waffle(white / 83, rows = 40, size = 0.25, colors = c("#1696d2", "#fdbf11"), title = "White", keep = FALSE, pad = 10),
  waffle(black / 83, rows = 40, size = 0.25, colors = c("#1696d2", "#fdbf11"), title = "Black", keep = FALSE),
  waffle(hispanic / 83, rows = 40, size = 0.25, colors = c("#1696d2", "#fdbf11"), title = "Hisp", keep = FALSE, pad = 59, xlab = "1 Square == 83 People")
) 
```


## Choropleth

### States

```{r state chorpleth}

library(fivethirtyeight)

states <- map_data("state") %>%
  select(lon = long, lat, group, state = region)

drivers.usa <- bad_drivers %>%
  mutate(state = tolower(state))
  
drivers.states <- left_join(states, drivers.usa, by = c("state" = "state"))

ggplot(drivers.states, aes(lon, lat, group = state)) +
  geom_polygon(aes(fill = perc_speeding)) +
  coord_quickmap() +
  labs(title = "Drivers Involved in Fatal Collision While Speeding",
       subtitle = "As a share of the number of fatal collisions per billion miles, 2009",
       caption = "Source: fivethirtyeight R package")  +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        axis.line = element_blank())
```


### Counties

```{r choropleth}
library(USAboundaries)

indiana.counties <- map_data("county", "indiana") %>%
  select(lon = long, lat, group, id = subregion)

indiana.census <- midwest %>%
  tbl_df() %>%
  filter(state == "IN") %>%
  mutate(county = tolower(county)) %>%
  select(county, area, poptotal, percwhite, percblack) 

census.counties <- left_join(indiana.census, indiana.counties, by = c("county" = "id"))
   
ggplot(census.counties, aes(lon, lat, group = county)) +
  geom_polygon(aes(fill = poptotal)) +
  coord_quickmap()  +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        axis.line = element_blank())

```


### Texas sales
```{r texas}

texas.counties <- map_data("county", "texas") %>%
  select(lon = long, lat, group, id = subregion)

texas.sales <- txhousing %>%
  filter(year == 2014) %>%
  select(city, sales) %>%
  mutate(city = tolower(city)) %>%
  group_by(city) %>%
  summarize(sales = sum(sales))

census.counties <- left_join(texas.counties, texas.sales, by = c("id" = "city"))

ggplot(census.counties, aes(lon, lat, group = id)) +
  geom_polygon(aes(fill = sales)) +
  coord_quickmap()  +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        axis.line = element_blank())



```

## Heat map

```{r heat map}

bad_drivers %>%
  mutate(`Number of Drivers` = scale(num_drivers)) %>%
  mutate(`Percent Speeding` = scale(perc_speeding)) %>%
  mutate(`Percent Alcohol` = scale(perc_alcohol)) %>%
  mutate(`Percent Not Distracted` = scale(perc_not_distracted)) %>%
  mutate(`Percent No Previous` = scale(perc_no_previous)) %>%
  select(-insurance_premiums, -losses, -(num_drivers:losses)) %>%
  gather(`Number of Drivers`:`Percent No Previous`, key = "variable", value = "SD's from Mean") %>%
  ggplot(aes(variable, state)) +
  geom_tile(aes(fill = `SD's from Mean`)) +
  ylab(NULL) +
  xlab(NULL) +
  labs(title = "Drivers Involved in Fatal Collisions By Behavior",
       subtitle = "As a share of the number of fatal collisions per billion miles, 2009",
       caption = "Source: fivethirtyeight R package") + 
  scale_fill_gradient(low = "white", high = "#1696d2")
#https://learnr.wordpress.com/2010/01/26/ggplot2-quick-heatmap-plotting/

```


## Small Multiples

Smaller font on the x- and y-axes makes sense for small multiples. 
```{r small multiples}

# Facet Wrap
txhousing %>%
  filter(city != "Brazoria County" & city != "Brownsville" & city != "San Angelo" & city != "Denton County") %>%
  ggplot(aes(median)) +
  geom_histogram() +
  facet_wrap(~city) +
  xlab("Median Monthly Home Value") +
  ylab("Count") +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Median Monthly Home Prices in Selected Texas Cities")

# Facet grid

```



#ggplot(mpg, aes(displ, hwy)) +
#  geom_point() +
#  facet_wrap(~class)



